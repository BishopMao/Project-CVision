<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <title>Hand Landmarks Detection</title>
    
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href=../index.html>Detection Options |</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle"  role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Menu
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href=../object-detection/index.html>Object Detection</a></li>
                            <li><a class="dropdown-item" href=../hand-landmark/index.html>Hand Landmark Detection</a></li>
                            <li><a class="dropdown-item" href=../face-landmark/index.html>Face Landmark Detection</a></li>
                            <li><a class="dropdown-item" href=../PoseLandmarker/index.html>Pose Landmark Detection</a></li>
                            <li><a class="dropdown-item" href=../imageclass/index.html>Image Classification</a></li>
                        </ul>
                    </li>
                </ul>
                <a class="navbar-brand" href="../help.html">ติดต่อเรา</a>
            </div>
        </div>
    </nav>
    <h1>Hand Landmark Detection using MediaPipe</h1>

    <section id="demos">
        <h2>Webcam Live Detection</h2>
        <p>Click the button below to enable your webcam.</p>
        <div id="liveView" class="videoView">
            <button id="webcamButton" class="mdc-button mdc-button--raised">
                <span class="mdc-button__label">ENABLE WEBCAM</span>
            </button>
            <div style="position: relative;">
                <video id="webcam" autoplay playsinline></video>
                <canvas class="output_canvas" id="output_canvas" style="position: absolute; left: 0; top: 0;"></canvas>
            </div>
        </div>
    </section>

    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script>
        const webcamButton = document.getElementById("webcamButton");
        const video = document.getElementById("webcam");
        const outputCanvas = document.getElementById("output_canvas");
        const canvasCtx = outputCanvas.getContext("2d");

        let webcamRunning = false;
        let handLandmarker;

        // Check if webcam access is supported
        const hasGetUserMedia = () => !!navigator.mediaDevices.getUserMedia;

        if (hasGetUserMedia()) {
            webcamButton.addEventListener("click", enableCam);
        } else {
            alert("Your browser does not support getUserMedia.");
        }

        // Load the hand landmarker
        async function setupHandLandmarker() {
            const { FilesetResolver, HandLandmarker } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0");
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 2
            });
        }

        // Enable the live webcam view
        async function enableCam() {
            if (webcamRunning) {
                webcamRunning = false;
                webcamButton.innerText = "ENABLE WEBCAM";
                video.srcObject.getTracks().forEach(track => track.stop());
            } else {
                webcamRunning = true;
                webcamButton.innerText = "DISABLE WEBCAM";

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    video.addEventListener("loadeddata", predictWebcam);
                    alert("Webcam connected successfully!");
                } catch (error) {
                    alert("Error connecting to webcam: " + error.message);
                }
            }
        }

        async function predictWebcam() {
            // Set canvas size
            outputCanvas.width = video.videoWidth;
            outputCanvas.height = video.videoHeight;

            // Draw the video frame to the canvas
            canvasCtx.drawImage(video, 0, 0, outputCanvas.width, outputCanvas.height);

            // Perform hand landmark detection
            if (handLandmarker) {
                const results = await handLandmarker.detectForVideo(video, performance.now());
                canvasCtx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
                
                if (results.landmarks) {
                    for (const landmarks of results.landmarks) {
                        drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: "#00FF00", lineWidth: 5 });
                        drawLandmarks(canvasCtx, landmarks, { color: "#FF0000", lineWidth: 2 });
                    }
                }
            }

            if (webcamRunning) {
                requestAnimationFrame(predictWebcam);
            }
        }

        // Initialize the hand landmarker
        setupHandLandmarker();
    </script>

</body>
</html>
